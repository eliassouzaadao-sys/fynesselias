// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model Pessoa {
  id            Int      @id @default(autoincrement())
  nome          String
  documento     String?  // CNPJ ou CPF
  tipo          String   @default("fornecedor") // 'fornecedor' ou 'cliente'
  status        String   @default("ativo") // 'ativo' ou 'inativo'
  contato       String?
  email         String?
  endereco      String?
  cidade        String?
  estado        String?
  cep           String?
  chavePix      String?
  tipoChavePix  String?  // celular, email, cpf, cnpj, aleatoria
  banco         String?
  agencia       String?
  contaBancaria String?
  tipoConta     String?
  observacoes   String?
  contas        Conta[]
  criadoEm      DateTime @default(now())
  atualizadoEm  DateTime @updatedAt

  // Relacionamento com usuário
  userId        Int
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Relacionamento com empresa
  empresaId     Int?
  empresa       Empresa? @relation(fields: [empresaId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([empresaId])
  @@index([tipo])
  @@index([status])
}

model Conta {
  id                  Int                 @id @default(autoincrement())
  descricao           String
  valor               Float
  vencimento          DateTime
  pago                Boolean             @default(false)
  dataPagamento       DateTime?           // data efetiva do pagamento/recebimento
  valorPago           Float?              // valor efetivamente pago (pode diferir do valor original)
  tipo                String              // 'pagar' ou 'receber'
  beneficiario        String?             // nome do beneficiário (opcional)
  fonte               String?             // fonte da receita (apenas para contas a receber)
  banco               String?             // banco de pagamento (opcional)
  categoria           String?             // categoria da despesa/receita
  subcategoria        String?             // subcategoria da despesa/receita
  formaPagamento      String?             // forma de pagamento
  numeroDocumento     String?             // número do documento (NF, boleto, etc)
  numeroParcela       String?             // número da parcela (ex: 1/12, 2/6)
  codigoTipo          String?             // código do tipo (ex: 001, FRN-001)
  observacoes         String?             // observações adicionais
  comprovante         String?             // URL do arquivo de comprovante

  // Status e fluxo de caixa
  status              String              @default("pendente") // pendente, pago, vencido, cancelado
  noFluxoCaixa        Boolean             @default(false) // se já está no fluxo de caixa

  // WhatsApp AI Integration
  createdViaWhatsApp  Boolean             @default(false)
  aiConfidence        Float?              // 0-1 confidence score from AI

  // Relationships
  pessoaId            Int?
  pessoa              Pessoa?             @relation(fields: [pessoaId], references: [id])
  whatsappMessages    WhatsAppMessage[]
  fluxoCaixa          FluxoCaixa?

  // Cartão de Crédito
  cartaoId            Int?
  cartao              CartaoCredito?      @relation(fields: [cartaoId], references: [id])
  faturaOrigem        Fatura?             @relation("FaturaConta")

  // Conta Bancária vinculada
  bancoContaId        Int?
  bancoConta          Banco?              @relation("ContaBanco", fields: [bancoContaId], references: [id])

  // Sócio responsável pelo gasto (para desconto no pró-labore)
  socioResponsavelId  Int?
  socioResponsavel    CentroCusto?        @relation("ContasSocio", fields: [socioResponsavelId], references: [id])

  // Controle de processamento do pró-labore (para não contar duas vezes)
  proLaboreProcessado Boolean             @default(false) // se já foi contabilizado em um pró-labore

  // Parcelamentos - conta macro (pai) com parcelas filhas
  isContaMacro        Boolean             @default(false) // true = conta macro que agrupa parcelas
  grupoParcelamentoId String?             // UUID para agrupar parcelas do mesmo parcelamento
  totalParcelas       Int?                // total de parcelas deste parcelamento

  // Relacionamento pai-filho para parcelamentos
  parentId            Int?
  parent              Conta?              @relation("ContaParcelas", fields: [parentId], references: [id])
  parcelas            Conta[]             @relation("ContaParcelas")
  valorTotal          Float?              // valor total do parcelamento (na conta macro)

  // Recorrência (para despesas fixas como aluguel, luz, água)
  isRecorrente        Boolean             @default(false) // se é conta recorrente
  frequencia          String?             // 'semanal', 'quinzenal', 'mensal', 'anual'
  recorrenciaInicio   Int?                // DEPRECATED - mês inicial da recorrência (1-12)
  recorrenciaFim      Int?                // DEPRECATED - mês final da recorrência (1-12)
  recorrenciaAno      Int?                // DEPRECATED - ano de referência para a recorrência
  recorrenciaDataInicio DateTime?         // data de início da recorrência
  recorrenciaDataFim    DateTime?         // data de fim da recorrência

  // Hierarquia para recorrências (template pai agrupa instâncias)
  recorrenciaParentId Int?
  recorrenciaParent   Conta?              @relation("ContaRecorrencia", fields: [recorrenciaParentId], references: [id])
  recorrencias        Conta[]             @relation("ContaRecorrencia")

  // Relacionamento com usuário
  userId              Int
  user                User                @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Relacionamento com empresa
  empresaId           Int?
  empresa             Empresa?            @relation(fields: [empresaId], references: [id], onDelete: Cascade)

  // Timestamps
  criadoEm            DateTime            @default(now())
  atualizadoEm        DateTime            @updatedAt

  @@index([tipo])
  @@index([status])
  @@index([pago])
  @@index([vencimento])
  @@index([cartaoId])
  @@index([socioResponsavelId])
  @@index([parentId])
  @@index([grupoParcelamentoId])
  @@index([isContaMacro])
  @@index([isRecorrente])
  @@index([recorrenciaParentId])
  @@index([bancoContaId])
  @@index([userId])
  @@index([empresaId])
}

model Banco {
  id           Int      @id @default(autoincrement())
  nome         String   // Nome do banco (ex: Bradesco, Itaú)
  codigo       String?  // Código do banco (ex: 001, 237, 341) - opcional
  agencia      String?  // Número da agência - opcional
  conta        String?  // Número da conta - opcional
  chavePix     String?  // Chave Pix
  tipoChavePix String?  // Tipo da chave: celular, email, cpf, cnpj, aleatoria
  saldoInicial Float    @default(0) // Saldo inicial da conta
  ativo        Boolean  @default(true)
  conciliadoEm DateTime? // Data/hora da última conciliação bancária
  criadoEm     DateTime @default(now())
  atualizadoEm DateTime @updatedAt

  // Relacionamento com FluxoCaixa
  movimentacoes FluxoCaixa[]

  // Relacionamento com Cartões de Crédito
  cartoes       CartaoCredito[]

  // Relacionamento com Contas (lançamentos vinculados)
  contas        Conta[]  @relation("ContaBanco")

  // Relacionamento com usuário
  userId        Int
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Relacionamento com empresa
  empresaId     Int?
  empresa       Empresa? @relation(fields: [empresaId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([empresaId])
}

model Categoria {
  id            Int           @id @default(autoincrement())
  nome          String
  tipo          String        // 'pagar' ou 'receber'
  ativo         Boolean       @default(true)
  subcategorias Subcategoria[]
  criadoEm      DateTime      @default(now())
  atualizadoEm  DateTime      @updatedAt

  // Relacionamento com usuário
  userId        Int
  user          User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Relacionamento com empresa
  empresaId     Int?
  empresa       Empresa?      @relation(fields: [empresaId], references: [id], onDelete: Cascade)

  @@unique([nome, tipo, empresaId])
  @@index([tipo])
  @@index([userId])
  @@index([empresaId])
}

model Subcategoria {
  id          Int       @id @default(autoincrement())
  nome        String
  ativo       Boolean   @default(true)
  categoriaId Int
  categoria   Categoria @relation(fields: [categoriaId], references: [id], onDelete: Cascade)
  criadoEm    DateTime  @default(now())
  atualizadoEm DateTime @updatedAt

  @@unique([nome, categoriaId])
  @@index([categoriaId])
}

model WhatsAppMessage {
  id                String   @id @default(cuid())
  phoneNumber       String
  message           String
  processedAt       DateTime @default(now())

  // AI Processing Results
  aiConfidence      Float?   // 0-1 confidence score
  extractedData     String?  // JSON string of extracted data

  // Status
  status            String   // "pending", "processed", "failed", "needs_confirmation"
  errorMessage      String?

  // Link to created transaction
  contaId           Int?
  conta             Conta?   @relation(fields: [contaId], references: [id])

  // User confirmation
  confirmed         Boolean  @default(false)
  confirmationDate  DateTime?

  // Relacionamento com usuário
  userId            Int
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Relacionamento com empresa
  empresaId         Int?
  empresa           Empresa? @relation(fields: [empresaId], references: [id], onDelete: Cascade)

  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@index([phoneNumber])
  @@index([status])
  @@index([createdAt])
  @@index([userId])
  @@index([empresaId])
}

model CentroCusto {
  id          Int      @id @default(autoincrement())
  nome        String
  sigla       String   // código/acronym (ex: FX, MKT)
  tipo        String   // 'despesa' (custo) ou 'faturamento' (receita)
  ativo       Boolean  @default(true)

  // Orçamento e realizado
  previsto    Float    @default(0) // valor previsto/orçado (para sócio = pró-labore base)
  realizado   Float    @default(0) // valor realizado/executado (para sócio = gastos no cartão)

  // Hierarquia (para subcentros)
  parentId    Int?
  parent      CentroCusto? @relation("SubCentros", fields: [parentId], references: [id])
  subcentros  CentroCusto[] @relation("SubCentros")

  // Campos para Sócio (quando isSocio = true)
  isSocio           Boolean  @default(false)
  cpfSocio          String?  // CPF do sócio
  descontoPrevisto  Float    @default(0) // Desconto previsto (de lançamentos recorrentes)
  descontoReal      Float    @default(0) // Desconto real (de lançamentos diretos no fluxo de caixa)

  // Contas onde este sócio é responsável (gastos pessoais)
  contasResponsavel Conta[] @relation("ContasSocio")

  // Descontos recorrentes do sócio (INSS, plano de saúde, etc.)
  descontosRecorrentes DescontoRecorrente[]

  // Relacionamento com usuário
  userId      Int
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Relacionamento com empresa
  empresaId   Int?
  empresa     Empresa? @relation(fields: [empresaId], references: [id], onDelete: Cascade)

  criadoEm    DateTime @default(now())
  atualizadoEm DateTime @updatedAt

  @@unique([sigla, empresaId])
  @@index([tipo])
  @@index([ativo])
  @@index([parentId])
  @@index([isSocio])
  @@index([userId])
  @@index([empresaId])
}

// Descontos recorrentes (previstos) do sócio
model DescontoRecorrente {
  id          Int      @id @default(autoincrement())
  nome        String   // Ex: "INSS", "Plano de Saúde", "Previdência Privada"
  valor       Float    // Valor mensal do desconto
  ativo       Boolean  @default(true)

  // Relacionamento com sócio (CentroCusto com isSocio=true)
  socioId     Int
  socio       CentroCusto @relation(fields: [socioId], references: [id], onDelete: Cascade)

  // Relacionamento com usuário
  userId      Int
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Relacionamento com empresa
  empresaId   Int?
  empresa     Empresa? @relation(fields: [empresaId], references: [id], onDelete: Cascade)

  criadoEm    DateTime @default(now())
  atualizadoEm DateTime @updatedAt

  @@index([socioId])
  @@index([ativo])
  @@index([userId])
  @@index([empresaId])
}

model FluxoCaixa {
  id                 Int      @id @default(autoincrement())
  dia                DateTime // data da movimentação
  codigoTipo         String   // código do tipo (ex: REC-001, PAG-045)
  fornecedorCliente  String   // nome do fornecedor ou cliente
  descricao          String?  // descrição opcional (ex: Tarifa de manutenção, Taxa DOC)
  valor              Float    // valor da movimentação
  tipo               String   // 'entrada' ou 'saida'
  fluxo              Float    // saldo acumulado após a movimentação

  // Relacionamento com a conta original
  contaId            Int?     @unique
  conta              Conta?   @relation(fields: [contaId], references: [id])

  // Centro de custo relacionado (pela sigla)
  centroCustoSigla   String?

  // Banco utilizado para o pagamento/recebimento
  bancoId            Int?
  banco              Banco?   @relation(fields: [bancoId], references: [id])

  // Cartão de crédito utilizado
  cartaoId           Int?
  cartao             CartaoCredito? @relation(fields: [cartaoId], references: [id])

  // Relacionamento com usuário
  userId             Int
  user               User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Relacionamento com empresa
  empresaId          Int?
  empresa            Empresa? @relation(fields: [empresaId], references: [id], onDelete: Cascade)

  criadoEm           DateTime @default(now())
  atualizadoEm       DateTime @updatedAt

  @@index([dia])
  @@index([tipo])
  @@index([centroCustoSigla])
  @@index([bancoId])
  @@index([cartaoId])
  @@index([userId])
  @@index([empresaId])
}

model CartaoCredito {
  id              Int       @id @default(autoincrement())
  nome            String    // Nome identificador (ex: "Nubank Pessoal")
  bandeira        String    // visa, mastercard, elo, amex, hipercard
  ultimos4Digitos String    // Últimos 4 dígitos do cartão
  diaVencimento   Int       // Dia do mês que vence a fatura (1-31)
  diaFechamento   Int       // Dia do mês que fecha a fatura (1-31)
  limite          Float     // Limite total do cartão
  ativo           Boolean   @default(true)

  // Relacionamento opcional com banco
  bancoId         Int?
  banco           Banco?    @relation(fields: [bancoId], references: [id])

  // Relacionamentos
  faturas         Fatura[]
  contas          Conta[]
  fluxoCaixa      FluxoCaixa[]

  // Relacionamento com usuário
  userId          Int
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Relacionamento com empresa
  empresaId       Int?
  empresa         Empresa?  @relation(fields: [empresaId], references: [id], onDelete: Cascade)

  criadoEm        DateTime  @default(now())
  atualizadoEm    DateTime  @updatedAt

  @@index([ativo])
  @@index([bancoId])
  @@index([userId])
  @@index([empresaId])
}

model Fatura {
  id              Int       @id @default(autoincrement())
  mesReferencia   Int       // Mês da fatura (1-12)
  anoReferencia   Int       // Ano da fatura (ex: 2026)
  valorTotal      Float     @default(0) // Soma dos lançamentos
  pago            Boolean   @default(false)
  dataPagamento   DateTime?
  dataVencimento  DateTime  // Data de vencimento calculada
  dataFechamento  DateTime  // Data de fechamento calculada

  // Relacionamento com cartão
  cartaoId        Int
  cartao          CartaoCredito @relation(fields: [cartaoId], references: [id], onDelete: Cascade)

  // Relacionamento com conta gerada ao pagar fatura
  contaFaturaId   Int?      @unique
  contaFatura     Conta?    @relation("FaturaConta", fields: [contaFaturaId], references: [id])

  // Relacionamento com usuário
  userId          Int
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Relacionamento com empresa
  empresaId       Int?
  empresa         Empresa?  @relation(fields: [empresaId], references: [id], onDelete: Cascade)

  criadoEm        DateTime  @default(now())
  atualizadoEm    DateTime  @updatedAt

  @@unique([cartaoId, mesReferencia, anoReferencia])
  @@index([cartaoId])
  @@index([pago])
  @@index([anoReferencia, mesReferencia])
  @@index([userId])
  @@index([empresaId])
}

// Histórico de pró-labore mensal
model HistoricoProLabore {
  id              Int       @id @default(autoincrement())
  mesReferencia   Int       // Mês (1-12)
  anoReferencia   Int       // Ano (ex: 2026)

  // Sócio relacionado
  socioId         Int
  socioNome       String    // Nome do sócio (snapshot)
  socioCpf        String?   // CPF do sócio (snapshot)

  // Valores do mês
  proLaboreBase   Float     // Valor base do pró-labore
  totalDescontos  Float     // Total de descontos do mês (previstos + reais)
  proLaboreLiquido Float    // Valor líquido (base - descontos)

  // Descontos previstos (recorrentes - INSS, plano de saúde, etc.)
  descontosPrevistos     Float   @default(0)  // Total de descontos recorrentes
  descontosPrevistosJson String? // JSON com detalhes dos descontos recorrentes

  // Descontos reais (manuais via fluxo de caixa ou contas)
  descontosReais         Float   @default(0)  // Total de descontos manuais
  descontosReaisJson     String? // JSON com detalhes das contas que geraram desconto

  // Detalhes dos descontos (DEPRECATED - manter para retrocompatibilidade)
  descontosJson   String?   // JSON com detalhes das contas que geraram desconto (old)

  // Conta gerada para pagamento
  contaGeradaId   Int?      // ID da conta a pagar gerada

  // Status
  pago            Boolean   @default(false)
  dataPagamento   DateTime?

  // Relacionamento com usuário
  userId          Int
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Relacionamento com empresa
  empresaId       Int?
  empresa         Empresa?  @relation(fields: [empresaId], references: [id], onDelete: Cascade)

  criadoEm        DateTime  @default(now())
  atualizadoEm    DateTime  @updatedAt

  @@unique([socioId, mesReferencia, anoReferencia, userId])
  @@index([socioId])
  @@index([anoReferencia, mesReferencia])
  @@index([pago])
  @@index([userId])
  @@index([empresaId])
}

// Usuário do sistema
model User {
  id        Int      @id @default(autoincrement())
  name      String
  email     String   @unique
  phone     String?
  company   String?
  password  String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Tokens de recuperação de senha
  passwordResetTokens PasswordResetToken[]

  // Empresas do usuário
  empresas          Empresa[]

  // Dados do usuário (mantidos para compatibilidade)
  pessoas           Pessoa[]
  contas            Conta[]
  bancos            Banco[]
  categorias        Categoria[]
  centrosCusto      CentroCusto[]
  fluxoCaixa        FluxoCaixa[]
  cartoes           CartaoCredito[]
  faturas           Fatura[]
  historicoProLabore HistoricoProLabore[]
  whatsappMessages  WhatsAppMessage[]
  descontosRecorrentes DescontoRecorrente[]

  @@index([email])
}

// Empresa (multi-tenant)
model Empresa {
  id           Int      @id @default(autoincrement())
  nome         String
  cnpj         String?
  nomeFantasia String?
  endereco     String?
  cidade       String?
  estado       String?
  cep          String?
  telefone     String?
  email        String?
  ativo        Boolean  @default(true)
  criadoEm     DateTime @default(now())
  atualizadoEm DateTime @updatedAt

  // Dono da empresa
  userId       Int
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Dados da empresa
  pessoas            Pessoa[]
  contas             Conta[]
  bancos             Banco[]
  categorias         Categoria[]
  centrosCusto       CentroCusto[]
  fluxoCaixa         FluxoCaixa[]
  cartoes            CartaoCredito[]
  faturas            Fatura[]
  historicoProLabore HistoricoProLabore[]
  whatsappMessages   WhatsAppMessage[]
  descontosRecorrentes DescontoRecorrente[]

  @@index([userId])
}

// Token de recuperação de senha
model PasswordResetToken {
  id        Int      @id @default(autoincrement())
  token     String   @unique
  userId    Int
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  expiresAt DateTime
  createdAt DateTime @default(now())

  @@index([token])
  @@index([userId])
}
